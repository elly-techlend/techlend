{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
 <div class="table-responsive">
  <h3 class="fw-bold mb-4">Payment Receipts</h3>

  <table class="table table-striped table-hover table-bordered align-middle">
    <thead class="table-dark text-center">
      <tr>
        <th>Voucher #</th>
        <th>Borrower Name</th>
        <th>Description</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Served By</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="voucher-table-body">
      {% for voucher in vouchers %}
      <tr>
        <td>{{ voucher.voucher_number }}</td>
        <td>{{ voucher.borrower.name if voucher.borrower else 'N/A' }}</td>
        <td>Loan Repayment</td>
        <td>{{ '{:,.2f}'.format(voucher.amount) }}</td>
        <td>{{ voucher.date.strftime('%Y-%m-%d') }}</td>
        <td>{{ voucher.creator.full_name if voucher.creator else 'System' }}</td>
        <td class="text-center">
          <button class="btn btn-sm btn-primary" onclick="viewReceipt({{ voucher.id }})">
            <i class="fa fa-eye"></i>
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
 </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" style="max-width: 500px;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="receiptModalLabel">Payment Receipt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="receipt-print-area">
        <!-- Receipt content will be loaded dynamically -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="printReceipt()">üñ®Ô∏è Print</button>
        <button id="download-btn" type="button" class="btn btn-success" onclick="downloadPDF()">‚¨áÔ∏è Download PDF</button>
    </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let currentVoucherId = null;

function viewReceipt(voucherId) {
    currentVoucherId = voucherId;

    fetch(`/vouchers/${voucherId}/receipt`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('receipt-print-area').innerHTML = html;
            new bootstrap.Modal(document.getElementById('receiptModal')).show();
        })
        .catch(err => console.error('Error loading receipt:', err));
}

function downloadPDF() {
    if (!currentVoucherId) {
        alert("Please select a voucher first.");
        return;
    }
    // Opens the PDF in a new tab and triggers download
    window.open(`/vouchers/${currentVoucherId}/download_pdf`, '_blank');
}

// Print receipt
function printReceipt() {
  const content = document.getElementById('receipt-print-area').innerHTML;
  const printWindow = window.open('', '', 'width=900,height=650');
  printWindow.document.write(`
    <html>
      <head>
        <title>Print Receipt</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 30px; color: #000; }
          h3,h4 { margin: 0; padding: 0; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #000; padding: 6px; font-size: 14px; }
          .fst-italic { font-style: italic; font-size: 12px; }
          .signature-block { display: flex; justify-content: space-between; margin-top: 40px; }
          .signature-block div { text-align: center; }
          @media print { body { margin: 10px; } }
        </style>
      </head>
      <body>${content}</body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  printWindow.close();
}

</script>
{% endblock %}
